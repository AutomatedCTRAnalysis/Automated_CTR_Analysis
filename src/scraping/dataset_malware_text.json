{
    "https://blog-assets.f-secure.com/wp-content/uploads/2019/10/15163408/BlackEnergy_Quedagh.pdf": {
        "mitre_domain": [
            "Enterprise"
        ],
        "tech_name": [
            "Abuse Elevation Control Mechanism: Bypass User Account Control",
            "Application Layer Protocol: Web Protocols",
            "Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder",
            "Boot or Logon Autostart Execution: Shortcut Modification",
            "Create or Modify System Process: Windows Service",
            "Credentials from Password Stores: Credentials from Web Browsers",
            "File and Directory Discovery",
            "Hijack Execution Flow: Services File Permissions Weakness",
            "Indicator Removal on Host",
            "Process Discovery",
            "Process Injection: Dynamic-link Library Injection",
            "Subvert Trust Controls: Code Signing Policy Modification",
            "System Information Discovery",
            "System Network Configuration Discovery",
            "System Network Connections Discovery",
            "Unsecured Credentials: Credentials In Files"
        ],
        "tech_id": [
            "T1548",
            "T1071",
            "T1547",
            "T1543",
            "T1555",
            "T1083",
            "T1574",
            "T1070",
            "T1057",
            "T1055",
            "T1553",
            "T1082",
            "T1016",
            "T1049",
            "T1552"
        ],
        "software_id": [
            "S0089"
        ],
        "text": "BLACKENERGY & QUEDAGH\nThe convergence of crimeware\nand APT attacks\nCONTENTS\nIntroduction 2\nAttack overview 2\nInfection vectors 3\nTarget details 4\n2008 cyberattacks on Georgia? 4\nUkraine-related proxies 4\nTimeline 6\nTechnical details 8\nUAC bypass during installation 8\nDriver signing policy bypass 8\nHijacking existing drivers 9\nDriver component 9\nMain DLL component 10\nBlackEnergy 3\n10\nInformation-stealing plugin 11\nNetwork traffic 12\nConclusions 13\nAppendix A | Samples 14BlackEnergy is a toolkit that has been used for years by various\ncriminal outfits. In the summer of 2014, we noted that certain\nsamples of BlackEnergy malware began targeting Ukranian\ngovernment organizations for information harvesting. These\nsamples were identified as being the work of one group,\nreferred to in this document as \u201cQuedagh\u201d, which has a history\nof targeting political organizations.\nThe Quedagh-related customizations to the BlackEnergy\nmalware include support for proxy servers and use of\ntechniques to bypass User Account Control and driver\nsigning features in 64-bit Windows systems. While monitoring\nBlackEnergy samples, we also uncovered a new variant used by\nthis group. We named this new variant BlackEnergy 3.\nThe use of BlackEnergy for a politically-oriented attack is an\nintriguing convergence of criminal activity and espionage. As\nthe kit is being used by multiple groups, it provides a greater\nmeasure of plausible deniability than is afforded by a custom-\nmade piece of code. TLP: WHITE\nF-SECURE LABS SECURITY RESPONSE\nMalware Analysis Whitepaper,2\nBLACKENERGY & QUEDAGH\nThe convergence of crimeware and APT attacks\nINTRODUCTION\nBlackEnergy is a popular crimeware (that is, malware\ndesigned to automate criminal activities) that is sold in the\nRussian cyber underground and dates back to as early as\n2007. Originally, it was designed as a toolkit for creating\nbotnets for use in conducting\nDistributed Denial of Service\n(DDoS) attacks. Over time, the malware has evolved to\nsupport different plugins, which are used to extend its\ncapabilities to provide necessary functions, depending on\nthe purpose of an attack.\nGiven the nature of its toolkit, BlackEnergy has\nunsurprisingly been used by different gangs for different\npurposes; some use it for sending spam, others for stealing\nbanking credentials. The most notorious use may be when\nit was used to conduct cyberattacks against Georgia during\nthe Russo-Georgian confrontation in 2008.\nIn the summer of 2014, BlackEnergy caught our attention\nwhen we noticed that samples of it were now tailored to target Ukrainian government institutions. Though it may\nbe unrelated, it is interesting to note that this change\nconveniently coincides with the on-going crisis in that\ncountry. Related or not, one thing is certain: the actor(s)\nusing these customized BlackEnergy malware are intent\non stealing information from the targets. The use of this\ncrimeware in what constitutes as an advance persistent\nthreat (APT) attack is interesting. In \u2018black operations\u2019\n(black ops), an important criteria is that the attack should\nnot be attributable - and what provides better plausible\ndeniability than crimeware known to be used by multiple\nparties?\nIn this paper we focus only on BlackEnergy samples\nknown to be used specifically by the actors we identify\nas Quedagh, who seem to have a particular interest in\npolitical targets. Special focus will be on the samples\nthat were used in targeted attacks against Ukrainian\ngovernment organizations earlier this year.\nATTACK OVERVIEW\nAt the time of writing, we have little information on how\nexactly victims are receiving the BlackEnergy malware\nbeing pushed by the Quedagh gang. An educated guess\nis that they are receiving the malware via targeted emails\ncontaining malicious attachments. Meanwhile, the\nfollowing infection and technical details are based on\nsamples gathered after searching through F-Secure Labs\u2019\ncollection of all BlackEnergy samples and identifying\nthose with Quedagh characteristics.\nFigure 1: BlackEnergy Builder from 2007The BlackEnergy toolkit comes with a builder application\nwhich is used to generate the clients that the attacker(s)\nuse to infect victim machines. The toolkit also comes\nwith server-side scripts, which the attackers set up in\nthe command and control (C&C) server. The scripts also\nprovide an interface where an attacker can control his\nbots. The simplicity and convenience provided by the\ntoolkit means that anyone who has access to the kit can\nbuild his own botnet without any skills required. , The convergence of crimeware and APT attacks\nBLACKENERGY &\nQUEDAGH\n3\nSome earlier installer variants, then named regedt32.\nexe, were distributed by documents exploiting software\nvulnerabilities, one of which was CVE-2010-3333. These\ndocuments drop and execute the installer, then open a\ndecoy document. It is reasonable to assume that a similar\napproach has been used to deliver the more recent\ninstaller variants.\nThe installer filename of BlackEnergy 3 is still msiexec.exe.\nHowever, it is delivered and executed by a dropper which\nopens a decoy document in the foreground. We also\nencountered a standalone, non-persistent sample that\npretends to be Adobe Flash Player Installer. It does not use\nany decoy document or application and does not run after\nreboot.\nThe overview below summarizes the various infection\nvectors used by the Quedagh gang to deliver BlackEnergy\ncrimeware to the designated targets.\nOVERVIEW OF INFECTION VECTORS USED AGAINST UKRAINIAN TARGETS\nAPP\nAPP\nmsiexec.exe\nmsiexec.exe\nmsiexec.exeINSTALLER\nINSTALLER\nINSTALLER\nDecoy\ndocument\nDecoy\ndocument\nClean app\nPERSISTENT component\nPERSISTENT component\nPERSISTENT component\nNON-PERSISTENT componentTrojanized app\nExploit document\nDropper malware\nFake installerThe original BlackEnergy toolkit first emerged in 2007 and\nis referred to in this paper as BlackEnergy 1. A later variant\nof the toolkit (BlackEnergy 2) was released in 2010. We also\nencountered a previously unseen variant, which had been\nrewritten and uses a different format for its configuration.\nIt also no longer uses a driver component. We dubbed this\nnew variant BlackEnergy 3. INFECTION VECTORS\nMost of the recent BlackEnergy installers collected are\nnamed msiexec.exe. We believe they are either dropped\nby another executable that uses social engineering tricks\nto mislead the user into executing the installer, or by\ndocuments containing exploits that silently perform the\ninstallation.\nWe found at least 2 trojanized legitimate applications that\nexecute the installer (in addition to their legitimate tasks).\nTrojanization is an effective infection method, as most\nusers have no way of observing that a malicious component\nis being installed in tandem with a legitimate program.,4\nBLACKENERGY & QUEDAGH\nThe convergence of crimeware and APT attacks\nImage 2:\nDecoy document circa 2012\nImage 3:\nStrings from a sample circa 2012TARGET DETAILS\nFrom the very earliest variants we were able to attribute\nto Quedagh, we have noticed that their targets have been\npolitical in nature. Apart from other indicators, we can\ndeduce the nature of the target based on the content of\nsocial engineering tactics used to distribute the installers.\nFor example, one decoy dropped from a sample dating to\n2012 (image 2) seems to be targeting European audiences\nand discusses a political/economic situation. Strings found\nin another sample from 2012 (image 3) again indicate\na political motivation behind the attack. Most decoys\nused content taken from news sites; we noted one decoy\ndropped by an exploit document was created using the\nRussian version of Office (image 4).\nThe latest variant of the dropper pretends to be a\ndocument file with a Ukrainian filename (image 5).\nThe choice of language for the filename again may tie\nin or reference the current political crisis in that country.\nThe filename itself means \u2018password list\u2019 in English.\n2008 CYBERATTACKS ON GEORGIA?\nDuring our investigation, we found interesting details\nthat lead us to suspect that Quedagh might have been\ninvolved in the cyberattacks launched against Georgia\nduring the 2008 Russo-Georgian confrontation. While the\ndetails identified are suggestive, they are not conclusive;\nthey do however seem consistent with the group\u2019s\ninvolvement in subsequent targeted attacks.\nUKRAINE-RELATED PROXIES\nWhile examining the samples collected during our\nBlackEnergy monitoring, we noticed that samples from\nthis year had been updated to support the use of proxy\nservers while connecting to their C&C servers. This\ncontrasts with earlier BlackEnergy 2 variants, which do\nnot support proxy servers. In some network setups, a\nproxy server is needed to allow internal users to access\nthe Internet\n[1]\n. BlackEnergy\u00b9s use of a proxy server may\nindicate that the gang has prior knowledge of the target\norganization\u2019s internal setup to note of this requirement.\nFor example, in one sample the configuration uses\nthe proxy server associated with the Ukrainian Railway\n(image 6). The configuration from another sample\nalso shows it using an internal proxy under the giknpc\ndomain (image 7). The domain giknpc.com.ua in turn\nhosts 3 domains (image 8), one of which is for the city\nof Dnipropetrovsk (image 9), the fourth-largest city in\nUkraine, located in the southeast. Based on the set proxy\nservers for the different samples, we concluded that the\ngang is targeting Ukrainian government organizations., The convergence of crimeware and APT attacks\nBLACKENERGY &\nQUEDAGH\n5\nImage 5:\n2014 dropper sample disguised as a document. The filename means password list\nImage 6:\nConfiguration using Ukrainian Railway\u2019s proxy\nImage 7:\nConfiguration using internal proxy under giknpc domain\nImage 8:\nDomains hosted on giknpc.com\nImage 9:\nDnipropetrovsk domain\nImage 4:\nDecoy document created using a Russian version of Office\n,6\nBLACKENERGY & QUEDAGH\nThe convergence of crimeware and APT attacks\nTIMELINE\nAlthough they may have started much earlier, the earliest\nBlackEnergy sample we could attribute to the Quedagh\ngang is from December 14, 2010.\nInitially, the group seemed to prefer to use the filename of\nthe Windows registry editor (regedt32.exe), presumably\nbecause the installer needs administrator rights to install\nits driver component and therefore would try to request\nfor the highest available rights (image 10), if possible. As\nthis triggers a notification message visible to the user, said\nuser is more likely to grant permission if it appears to be\nthe registry editor that is requesting for permission, since\nit is normal to run it with administrator rights. Experienced\nusers though are less likely to be taken in, thereby\ndecreasing the likelihood of a successful infection.\nStarting April 2013, modified installers appeared showing\nthat the Quedagh group found a way to bypass the default\nUser Account Control (UAC) settings. With this change,\nthe user\u2019s permission is no longer need (image 11). At this\npoint, the gang also began to use the Windows installer\nprogram filename msiexec.exe.\n64-bit support\nWithin a month of Windows 8.1\u2019s release, the gang\nhad quickly added support for 64-bit systems, possibly\nanticipating that more of their target systems will be\nmigrated to 64-bit systems. They also employ a neat\ntrick to bypass the driver signing requirement on 64-\nbit Windows systems. As a side note, this latest finding\nupdates and supercedes previously published research\nrelated to BlackEnergy\u2019s driver signing behavior\n[2]\n.\nHowever, this trick doesn\u2019t work on Windows 8 and\nlater systems. The driver also crashes occassionally. This\ncould be the reason for the stand-alone non-persistent\nBlackEnergy variant.\nBlackEnergy 3\nWe identified the new BlackEnergy 3 variant first by the\nchange in its configuration, which differed from those\nof its two predecessors, 1 and 2 (images 12 to 14).\nIt also\nno longer uses a driver component\n[3]\n.\nFurther technical\ndetails are documented on page 10 to 11.\nImage 10:\nInstaller requesting highest available rights\nImage 11:\nInstaller execution privilege level amended,Image 14: BlackEnergy 3 configurationImage 12: BlackEnergy 1 configuration\nImage 13: BlackEnergy 2 (aka BotnetKernel\nor bkernel\n[4]\n) configuration\n20072010201320082009201120122014\nBlackEnergy 1BlackEnergy 2BlackEnergy 3\nCYBERATTACKS AGAINST GEORGIA\nFirst installer\n(regedt32.exe)New UAC-bypassing installer\n(msiexec.exe) Quedagh APT campaignBLACKENERGY Development\n64-bit support for BlackEnergy 2 driverTargets Ukrainian entities May 12\nSome time after Dec 25Nov 14Apr 9Dec 14TIMELINE OF BLACKENERGY & QUEDAGH HISTORY\nPOLITICAL CRISIS IN UKAINE,8\nBLACKENERGY & QUEDAGH\nThe convergence of crimeware and APT attacks\nTECHNICAL DETAILS\nUAC BYPASS DURING INSTALLATION\nThe malware will only attempt to infect a system if the\ncurrent user is a member of the local administrator group.\nIf not, it will re-launch itself as Administrator on Vista.\nThis in effect will trigger a UAC prompt. On Windows 7\nand later however, the malware will attempt to bypass the\ndefault UAC settings. It exploits a backward-compatibility\nfeature found in newer versions of Windows. BlackEnergy\ninstallers include a Shim Database, or a \u201cfix\u201d, instructing\nSndVol.exe to execute cmd.exe (image 15, below) instead\nin order to resolve the incompatibility.\nSndVol.exe is one of the Windows executables that will\nbe automatically elevated upon execution because it\nis thought to be safe. What harm can a volume control\ncause? With the malicious \u201cfix\u201d installed however,\nexecuting SndVol.exe will execute the not-so-safe file\ncmd.exe instead, which can then be used to install the\nmalware while in an elevated state. DRIVER SIGNING POLICY BYPASS\nThe role of the installer is to set up the malware\u2019s\npersistent component, which is the driver component.\nOn 64-bit Windows systems, Microsoft has enforced a\npolicy that requires all drivers to be signed as a security\nprecaution. Signing provides a way to identify a driver to\nits author, effectively reducing the number of malware\ndevelopers willing to take the risk. To allow developers to\ntest their drivers during development, Microsoft provides\na TESTSIGNING boot configuration option; while in this\nmode, a watermark is displayed on the screen to make it\nobvious to users and to prevent malware from exploiting\nthis option.\nBlackEnergy enables the TESTSIGNING option to load its\ndriver component; to hide this change from the user, the\nmalware removes the watermark by removing the relevant\nstrings in the user32.dll.mui of the system. In Windows\n8 and up however, the strings are no longer stored in\nuser32.dll.mui, so the trick will not work. This may be one\nof the reasons for the existence of a standalone non-\npersistent BlackEnergy variant. The malware does not\ninfect 64-bit Windows systems that are older than Vista.\nImage 15: Malicious fix to redirect SndVol.exe to cmd.exe. Inset: Test Mode watermark, The convergence of crimeware and APT attacks\nBLACKENERGY &\nQUEDAGH\n9\nHIJACKING EXISTING DRIVERS\nThe installer will try to locate an existing driver service\nthat is inactive. The service found will usually be a\nlegitimate one that is disabled because it is no longer\nused or because it is set to start only on demand. The\ninstaller will drop the driver component using the\ncorresponding path of the service.\nIt will overwrite the\nexisting driver if necessary. The hijacked service is then\nset to start automatically. This is how the malware is able\nto survive after a reboot. By doing this, the gang may be\nhoping that their malicious driver will be overlooked by\nadministrators or investigators who are so used to seeing\nthose legitimate services. DRIVER COMPONENT\nThe only component that will remain permanently on the\ninfected system will be the driver component. The driver\ncomponent used by the gang is a stripped down version\nof the BlackEnergy 2 driver.\nThe sole purpose of this driver component is to inject\nthe main DLL component into svchost.exe. Interestingly,\nit does not contain the rootkit functionalities for hiding\nprocesses, files and registry objects that is found in the\nusual BlackEnergy 2 drivers. The gang may have opted for\na \u2018hide in plain sight\u2019 approach to evade detections from\nrootkit scanners, such as GMER and RootkitRevealer, that\nchecks for system anomalies.\nThe driver component provides a IOCTL interface to\ncommunicate with the main DLL component. Table 1\n(above) summarizes the command codes that can be\npassed to the IOCTL buffer. The 32-bit version contains\nadditional, incomplete routines for hiding processes via\ndirect kernel object manipulation (DKOM) and managing\nBlackEnergy 2 rootkit rules in memory\n[2]\n.\nCodeFunction\n6Loads a driver into memory\n9Does not do anything; just returns true.\nPreviously contained an uninstall routine.\n10Returns the registry path and driver file path\nLocate inactive drivers\nReplace with driver component\nAdditional steps on 64-bit systems\nEnable TESTSIGNING\nRemove Test Mode watermark\nRun as administrator\nBypass UAC\nNeed rights?\nTemporary componentINSTALLER\nDRIVER\nMAIN DLLPersistent component\nsvchost.exe\nInstalls\nInjectsDIAGRAM 1: INSTALLATION FLOWDIAGRAM 2: ROLE OF DRIVER COMPONENT\nTABLE 1: IOCTL BUFFER COMMAND CODES,10\nBLACKENERGY & QUEDAGH\nThe convergence of crimeware and APT attacks\nBlackEnergy 2 was very well documented by Dell\nSecureWorks\n[5]\nin 2010. Table 2 (above) summarizes\nthe differences between the driver component used by\nQuedagh compared to the typical BlackEnergy 2.\nMAIN DLL COMPONENT\nThe core functionality of BlackEnergy 2 is found in the\nmain DLL component. This component is embedded inside\nthe driver component and is not found in the file system;\nthis is to reduce the infection footprint on the system.\nThe main DLL provides a robust framework for attackers\nto maintain a botnet that is not tied to any specific\nfunctionality. The malware is designed to be used by\nloading customized plugins depending on the purpose\nof the botmaster. It is mainly a framework for plugins\nto communicate with a central command and control.\nOtherwise, the main DLL only provides a minimal set of\ncommands. Table 3 (above) summarizes the commands\nsupported by the variants used in the attack against\nUkrainian government organizations.In BlackEnergy 2, the main DLL component communicates\nwith its plugins via a defined set of API calls. It exports\na number of function calls, which can be used by the\nplugins. On the other hand, plugins are required to export\n2 functions to work. We highly recommend the research\nof Dell SecureWorks for those looking for more details\nregarding the BlackEnergy 2 plugin framework.\nBLACKENERGY 3\nIn contrast to previous variants, BlackEnergy 3 uses a\nsimpler installer component. It does not have a driver\ncomponent and the installer drops the main DLL\ncomponent directly to the local application data (non-\nroaming) folder. The installer then creates a LNK file in the\nstartup folder, using a filename generated based on the\nvolume serial number as a launch point. The LNK file is a\nshortcut to execute the main DLL using rundll32.exe.\nCommandDescription\nrexecDownload and execute a binary\nlexecExecute a shell command\ndieUninstall\ngetplLoad a plugin\nturnoffQuit (will start again after reboot)\nchprtAdd / remove / set active command and control server\nTypical BlackEnergy 2Quedagh BlackEnergy 2\nLaunch PointCreates a new service based on either\na hardcoded or randomly generated\nname (depending on the installer)Hijacks an existing legitimate service\nRoleHides processes, files and registry\nobjects; Inject main DLL to svchost.exeInjects main DLL to svchost.exe\nVersions32-bit driver component that contains\ncomplete routines in its IOCTL\ninterface32-bit driver component with a lot of remnant routines in\nits IOCTL interface, only a few of which make sense.\nAfter Nov 11, 2013, the 64-bit driver component is available\nand provides limited functionalities in IOCTL interface (only\nthose equivalent working routines found in the 32-bit versions)TABLE 2: TYPICAL BLACKENERGY DRIVER COMPONENT VERSUS\nQUEDAGH\u2019S CUSTOM COMPONENT\nTABLE 3: COMMANDS SUPPORTED BY VARIANTS TARGETED AT UKRAINIAN ENTITIES\nTABLE 4: X509_ASN FIELDS & EQUIVALENT BLACKENERGY 2 XML NODE, The convergence of crimeware and APT attacks\nBLACKENERGY &\nQUEDAGH\n11\nIDBlackEnergy 2 NodeDescription\n1serversThe command and control servers\n2pluginsPlugins to be loaded\n3cmdsCommands to be executed\n4build idBuild ID\n5sleepfreqPhone home interval\nCommandDescription\ndeleteUninstall\nldplgLoad a plugin\nunlplgUnload a plugin\nupdateUpdate main DLL\ndexec Download and execute an executable\nexecDownload and execute a binary\nupdcfgUpdate the configuration data\nThis variant uses a new configuration format. The\nconfiguration data is a series of X509_ASN encoded values\nand are accessed by an ID number. Table 4 summarizes\nthe fields and their equivalent BlackEnergy 2 XML node,\nwhile table 5 lists the completely new set of commands\nused in this latest variant.\nBlackEnergy 3 also uses a different method of\ncommunication with its plugins, as it now communicates\nvia RPC over the named-pipe protocol (ncacn_np).\nINFORMATION-STEALING PLUGIN\nSince the main DLL component offers little clue as to what\nthe malware was used for, we need to look at the plugin to\ndetermine the objective of the gang.\nOne particular plugin that was used in the campaign was\ncalled \u201csi\u201d, perhaps to mean \u2018steal information\u2019. The latest\nsample we found will attempt to gather the following\ninformation and send them to the C&C server:\n\u2022 System configuration information (gathered via systeminfo.exe)\n\u2022 Operating system version\n\u2022 Privileges\n\u2022 Current time\n\u2022 Up time\n\u2022 Idle Time\n\u2022 Proxy\n\u2022 Installed apps (gathered from uninstall program registry)\n\u2022 Process list (gathered via tasklist.exe)\n\u2022 IP configurations (gathered via ipconfig.exe)\n\u2022 Network connections (gathered via netstat.exe)\n\u2022 Routing tables (gathered via route.exe)\n\u2022 Traceroute and Ping information to Google (gathered via tracert.exe and ping.exe)\n\u2022 Registered mail, browser, and instant messaging clients (gathered via client registry)\u2022 Account and password information from The Bat! email client (gathered from account.cfn and account.cfg)\n\u2022 Stored username and passwords in Mozilla password manager of the following applications (gathered from signons*.txt and signons.sqlite)\n\u2022 Thunderbird\n\u2022 Firefox\n\u2022 SeaMonkey\n\u2022 IceDragon\n\u2022 Stored username and passwords in Google Chrome password manager of the following applications (gathered from \u201cLogin Data\u201d)\n\u2022 Google Chrome\u2022 Chromium\n\u2022 Comodo Dragon\n\u2022 Xpom\n\u2022 Nichrome\n\u2022 QIP Surf\n\u2022 Torch\n\u2022\nYandexBrowser\n\u2022 Opera\n\u2022 Sleipnir\n\u2022 Account and password information from Outlook and Outlook Express\n\u2022 Internet Explorer version and stored username and passwords\n\u2022 Stored username and passwords in Windows Credential Store\n\u2022 Live\n\u2022 Remote Desktop\n\u2022 Other generic credentials (Microsoft_WinInet_*)\nThe nature of the information being gathered seems to\nbe generic rather than targeted. This may be because the\nmalware has roots from crimeware. The information is still\nuseful however as such data makes it easier for the gang\nto plan any further attacks on the same targets. TABLE 4: X509_ASN FIELDS & EQUIVALENT BLACKENERGY 2 XML NODETABLE 5: BLACKENERGY 3 COMMANDS,12\nBLACKENERGY & QUEDAGH\nThe convergence of crimeware and APT attacks\nNETWORK TRAFFIC\nBlackEnergy communicates with its C&C server via HTTP\nPOST requests. For the BlackEnergy 2 samples used by the\ngang, the request contains the following fields:\nid=[bot_id]&bid=[base64_encoded_build_\nid]&dv=[x]&mv=[y]&dpv=[z]\nWhere:\n\u2022 bot_id is equivalent to the infected host name and the volume serial number following the format x[host_name]_[serial_no] (e.g. xJOE-PC_484DA98A)\n\u2022 build_id is the string found in the build_id field in the sample\u2019s configuration data\n\u2022 x, y, z are hardcoded values which varies among samples\nThe fields are almost the same for BlackEnergy 3 samples:\nid=[bot_id_sha1]&bid=[base64_encoded_build_\nid]&nm=[x]&cn=[y]&num=[z]\nThe only major difference is that the id field contain just\nthe hash instead of the actual string. The actual bot_id\nstring in which the id hash is derived is also a bit different;\nit now uses the format [domain_sid]_[host_name]_\n[serial_no].The response of the command and control server will\nbe encrypted using the id field in the POST request as\nthe key. After the response is decrypted, it will be in the\nform of the corresponding configuration data of the\nBlackEnergy sample; for example, BlackEnergy 2 samples\nexpect the decrypted response to be a XML document,\nwhile BlackEnergy 3 samples expect the decrypted\nresponse to be a series X509_ASN encoded values.\nThe decrypted response, which is equivalent to another\nconfiguration data, will be processed similar to the initial\nconfiguration data embedded in the main DLL; the only\ndifferences are the data fields that are processed. This\ncycle is illustrated in diagram 3 (above).\nThe main DLL also uses the fields listed in table 6 (above)\nwhen it needs to download additional files.\nHTTP POST FieldDescription of Values\ngetpThe plugin name to be downloaded\nplvSome variants specify the version of the plugin to be downloaded\ngetpdThe binary name to be downloadedTABLE 6: MAIN DLL\u2019S ADDITIONAL COMMANDS DURING DOWNLOAD OF ADDITIONAL FILESDIAGRAM 3: CONFIGURATION DATA HANDLING MAIN DLL\nConfig\nConfig\nC&C\nSERVER\nHTTP POST\n1\n2\n3\n1\n2\n3\nMain DLL process configuration data embedded\nin its body; will only process fields related to C&C\ncommunication. BlackEnergy 2 configuration may\nalso contain initial commands to execute.\nMain DLL reports to C&C.\nMain DLL processes the configuration data\nreturned by the C&C. This time, it processes\nfields related to plugins and commands., The convergence of crimeware and APT attacks\nBLACKENERGY &\nQUEDAGH\n13\nCONCLUSIONS\nBlackEnergy is a toolkit that has been used for years\nby various criminal outfits. In the summer of 2014, we\nnoted that certain samples of BlackEnergy malware\nbegan targeting Ukranian government organizations for\ninformation harvesting. These samples were identified as\nbeing the work of one group, referred to in this document\nas \u201cQuedagh\u201d, which has a history of targeting political\norganizations. Though inconclusive, suggestive details\nindicate that BlackEnergy malware, possibly also from this\ngang, may also have been used in the Russo-Georgian\nconfrontation in 2008.\nThe Quedagh-customizations to the BlackEnergy malware\ninclude support for proxy servers (which, in the samples\nexamined are associated with Ukrainian entities) and\nuse of techniques to bypass User Account Control and\ndriver signing features in 64-bit Windows systems. While\nmonitoring BlackEnergy samples, we also encountered a\nnew variant, which we dub BlackEnergy 3, with a modified\nconfiguration, no driver component and a different\ninstallation procedure.\nThe use of BlackEnergy for a politically-oriented attack\nis an intriguing convergence of criminal activity and\nespionage. As the kit is being used by multiple groups, it\nprovides a greater measure of plausible deniability than is\nafforded by a custom-made piece of code.\n.REFERENCES\n1. Wikipedia; Proxy server; http://en.wikipedia.org/wiki/Proxy_server#Cross-domain_resources\n2. Broderick Aquilino; F-Secure Weblog;\nBlackEnergy Rootkit, Sort Of; 13 June 2014; http://www.f-secure.com/weblog/archives/00002715.html\n3. Broderick Aquilino; F-Secure Weblog;\nBeware BlackEnergy If Involved In Europe/Ukraine Diplomacy ; 30 June 2014;\nhttp://www.f-secure.com/weblog/archives/00002721.html\n4. Kafeine; Malware don\u2019t need Coffee;\nBotnetKernel (MS:Win32/Phdet.S) an evolution of BlackEnergy\n; 21 June 2014; http://malware.dontneedcoffee.com/2014/06/botnetkernel.html\n5. Joe Stewart; DELL SecureWorks;\nBlackEnergy Version 2 Analysis ; 3 March 2010;\nhttp://www.secureworks.com/cyber-threat-intelligence/threats/blackenergy2/,14\nBLACKENERGY & QUEDAGH\nThe convergence of crimeware and APT attacks\nSHA1Description\n26b9816b3f9e2f350cc92ef4c30a097c6fec7798 Main reference for related BlackEnergy 2 32-bit driver and main\nDLL component analysis\nbf9937489cb268f974d3527e877575b4fbb07cb0 Main reference for related BlackEnergy 2 64-bit driver (signed\non 2013-12-25) and installer analysis. Basis for the start of the\nUkrainian target.\n78636f7bbd52ea80d79b4e2a7882403092bbb02d Main reference for related BlackEnergy 3 analysis\nbf9172e87e9264d1cddfc36cbaa74402bb405708 Main reference for related si plugin analysis\n441cfbaba1dfd58ce03792ef74d183529e8e0104 Stand-alone non-persistent BlackEnergy 2 sample\nf7d4aa90b76646f4a011585eb43b9d13c60f48eb Trojanized Juniper installer containing related BlackEnergy 2\n8ccd2962bce8985d0794daed6e0bf73e5557cfe8 Trojanized Adobe Bootstrapper containing related BlackEnergy\n2. This means that it is highly probable that there is a trojanized\nAdobe package out there.\nd496f99f7e07d5cbbd177a9d43febe8fb87ebc3b Related RTF document containing exploit\ncc71aa8f919911676fb5d775c81afc682e6e3dd3 Related BlackEnergy 2 binary containing strings that are\npolitical in nature\nabab02d663872bcdbe2e008441fcd7157c0eb52d Oldest (compiled on 2010-12-14) related BlackEnergy 2 installer\nthat was found\ne5c8c10b10ee288512d3a7c79ae1249b57857d23 Oldest (compiled on 2013-04-09) related BlackEnergy 2\ninstaller that bypass UAC that was found\n8743c8994cc1e8219697394b5cb494efa7dad796 Oldest (signed on 2013-11-14) related BlackEnergy 2 64-bit\ndriver that was found\n285b3252a878d1c633ea988153bbc23c148dd630 Oldest (compiled on 2014-05-12) related BlackEnergy 3 dropper\nthat was found APPENDIX A | SAMPLES, The convergence of crimeware and APT attacks\nBLACKENERGY &\nQUEDAGH\n15\nPAGE INTENTIONALLY LEFT BLANK, F-Secure is an online security and privacy company from Finland. We\noffer millions of people around the globe the power to surf invisibly\nand store and share stuff, safe from online threats.\nWe are here to fight for digital freedom.\nJoin the movement and switch on freedom.\nFounded in 1988, F-Secure is listed on NASDAQ OMX Helsinki Ltd.F-Secure is an online security and privacy company from Finland.\nWe offer millions of people around the globe the power to surf\ninvisibly and store and share stuff, safe from online threats.\nWe are here to fight for digital freedom.\nJoin the movement and switch on freedom.\nFounded in 1988, F-Secure is listed on NASDAQ OMX Helsinki Ltd. SWITCH\nON\nFREEDOM"
    },
    "https://securelist.com/be2-custom-plugins-router-abuse-and-target-profiles/67353/": {
        "mitre_domain": [
            "Enterprise"
        ],
        "tech_name": [
            "Credentials from Password Stores: Credentials from Web Browsers",
            "Fallback Channels",
            "File and Directory Discovery",
            "Input Capture: Keylogging",
            "Network Service Discovery",
            "Peripheral Device Discovery",
            "Process Discovery",
            "Remote Services: SMB/Windows Admin Shares",
            "Screen Capture",
            "System Information Discovery",
            "System Network Configuration Discovery",
            "System Network Connections Discovery",
            "Unsecured Credentials: Credentials In Files"
        ],
        "tech_id": [
            "T1555",
            "T1008",
            "T1083",
            "T1056",
            "T1046",
            "T1120",
            "T1057",
            "T1021",
            "T1113",
            "T1082",
            "T1016",
            "T1049",
            "T1552"
        ],
        "software_id": [
            "S0089"
        ],
        "text": "\nBE2 Custom Plugins, Router Abuse, and Target Profiles | Securelist\nSolutions for:\nHome Products\nSmall Business 1-50 employees\nMedium Business 51-999 employees\nEnterprise 1000+ employees\nby Kaspersky\nCompanyAccount\nGet In Touch\nDark mode off\nEnglishRussianSpanish\nSolutions\nHybrid Cloud SecurityLearn More\nInternet of Things & Embedded SecurityLearn More\nThreat Management and DefenseLearn More\nIndustrial CybersecurityLearn More\nFraud PreventionLearn More\nOther solutions\nBlockchain Security\nKaspersky for Security Operations Center\nIndustries\nNational CybersecurityLearn More\nIndustrial CybersecurityLearn More\nFinance Services CybersecurityLearn More\nHealthcare CybersecurityLearn More\nTransportation CybersecurityLearn More\nRetail CybersecurityLearn More\nOther Industries\nTelecom Cybersecurity\nBlockchain Security\nView all\nProducts\nKasperskyEndpoint Security for BusinessLearn More\nKasperskyEndpoint Detection and Response (EDR)Learn More\nKasperskyEDR OptimumLearn More\nKasperskyAnti Targeted Attack PlatformLearn More\nKasperskyManaged Detection and ResponseLearn More\nKasperskySandboxLearn More\nOther Products\nKaspersky Security for Mail Server\nKaspersky Security for Internet Gateway\nKaspersky Embedded Systems Security\nKaspersky Hybrid Cloud Security for AWS\nKaspersky Hybrid Cloud Security for Azure\nView All\nServices\nKasperskyCybersecurity ServicesLearn More\nKasperskyAdaptive Online TrainingLearn More\nKasperskyPremium SupportLearn More\nKasperskyThreat IntelligenceLearn More\nKasperskyAPT Intelligence ReportingLearn More\nKasperskyTargeted Attack DiscoveryLearn More\nOther Services\nKaspersky Professional Services\nKaspersky Incident Response\nKaspersky Cybersecurity Training\nKaspersky Incident Communications\nKaspersky Security Awareness\nView All\nResource Center\nCase Studies\nWhite Papers\nDatasheets\nTechnologies\nMITRE ATT&CK\nAbout Us\nTransparency\nCorporate News\nPress Center\nCareers\nInnovation Hub\nSponsorship\nPolicy Blog\nContacts\nGDPR\nSubscribe\nDark mode off\nLogin\nSecurelist menu\nEnglishRussianSpanish\nExisting Customers\nPersonal\nMy Kaspersky\nRenew your product\nUpdate your product\nCustomer support\nBusiness\nKSOS portal\nKaspersky Business Hub\nTechnical Support\nKnowledge Base\nRenew License\nHome\nProducts\nTrials&Update\nResource Center\nBusiness\nSmall Business (1-50 employees)\nMedium Business (51-999 employees)\nEnterprise (1000+ employees)\nSecurelist\nThreats\nFinancial threats\nMobile threats\nWeb threats\nSecure environment (IoT)\nVulnerabilities and exploits\nSpam and Phishing\nIndustrial threats\nCategories\nAPT reports\nIncidents\nResearch\nMalware reports\nSpam and phishing reports\nPublications\nKaspersky Security Bulletin\nArchive\nAll Tags\nAPT Logbook\nWebinars\nStatistics\nEncyclopedia\nThreats descriptions\nKSB 2021\nAbout Us\nCompany\nTransparency\nCorporate News\nPress Center\nCareers\nSponsorships\nPolicy Blog\nContacts\nPartners\nFind a Partner\nPartner Program\nContent menu\nClose\nSubscribe\nby Kaspersky\nDark mode off\nThreatsThreats\nAPT (Targeted attacks)\nSecure environment (IoT)\nMobile threats\nFinancial threats\nSpam and phishing\nIndustrial threats\nWeb threats\nVulnerabilities and exploits\nCategoriesCategories\nAPT reports\nMalware descriptions\nSecurity Bulletin\nMalware reports\nSpam and phishing reports\nSecurity technologies\nResearch\nPublications\nOther sections\nArchive\nAll tags\nWebinars\nAPT Logbook\nStatistics\nEncyclopedia\nThreats descriptions\nKSB 2021\nAPT reports\nBE2 custom plugins, router abuse, and target profiles\nAPT reports\n03 Nov 2014\nminute read\nTable of Contents\nBrief HistoryThe Plugins and Config FilesLinux pluginsWindows PluginsTracked CommandsHard-Coded Command and ControlBE2 Targets and VictimsVictim casesBuild IDsAppendix: IoCPrevious and Parallel Research\nAuthors\nKurt Baumgartner\nMaria Garnaeva\nNew observations on BlackEnergy2 APT activity\nThe BlackEnergy malware is crimeware turned APT tool and is used in significant geopolitical operations lightly documented over the past year. An even more interesting part of the BlackEnergy story is the relatively unknown custom plugin capabilities to attack ARM and MIPS platforms, scripts for Cisco network devices, destructive plugins, a certificate stealer and more. Here,\u00a0we present available data \u2013 it is difficult to collect on this APT.\u00a0We will also present more details on targets previously unavailable and present related victim profile data.\nThese attackers are careful to hide and defend their long-term presence within compromised environments. The malware\u2019s previously undescribed breadth means attackers present new technical challenges in unusual environments, including SCADA networks. Challenges, like mitigating the attackers\u2019 lateral movement across compromised network routers, may take an organization\u2019s defenders far beyond their standard routine and out of their comfort zone.\nBrief History\nBlackEnergy2 and BlackEnergy3 are known tools. Initially, cybercriminals used BlackEnergy custom plugins for launching DDoS attacks. There are no indications of how many groups possess this tool. BlackEnergy2 was eventually seen downloading more crimeware plugins \u2013 a custom spam plugin and a banking information stealer custom plugin. Over time, BlackEnergy2 was assumed into the toolset of the BE2/Sandworm actor. While another crimeware group continues to use BlackEnergy to launch DDoS attacks, the BE2 APT appears to have used this tool exclusively throughout 2014 at victim sites and included custom plugins and scripts of their own. To be clear, our name for this actor has been the BE2 APT, while it has been called \u201cSandworm Team\u201d also.\nThe Plugins and Config Files\nBefore evidence of BlackEnergy2 use in targeted attacks was uncovered, we tracked strange activity on one of the BlackEnergy CnC servers in 2013. This strangeness\u00a0was related to values listed in newer\u00a0BlackEnergy configuration files. As described in Dmitry\u2019s 2010 Black DDoS\u2019 analysis, a configuration file is downloaded from the server by main.dll on an infected system. The config file provides download instructions for the loader. It also instructs the loader to pass certain commands to the plugins. In this particular case in 2013, the config file included an unknown plugin set, aside from the usual \u2018ddos\u2019 plugin listing. Displayed below are these new, xml formatted plugin names \u201cweap_hwi\u201d, \u201cps\u201d, and \u201cvsnet\u201d in a BlackEnergy configuration file download from a c2 server. This new module push must have been among the first for this group, because all of the module versions were listed as \u201cversion 1\u201d, including the ddos plugin:\nConfig downloaded from BE2 server\nThe \u2018ps\u2019 plugin turned out to be password stealer. The \u2018vsnet\u2019 plugin was intended to spread and launch a payload (BlackEnergy2 dropper itself at the moment) in the local network by using PsExec, as well as gaining primary information on the user\u2019s computer and network.\nMost surprising was the \u2018weap_hwi\u2019 plugin. It was a ddos tool compiled to run on ARM systems:\nWeap_hwi plugin\nAt first, we didn\u2019t know whether the ARM plugin was listed intentionally or by mistake, so we proceeded to collect the CnC\u2019s config files. After pulling multiple config files, we confirmed that this ARM object inclusion was not a\u00a0one-off mistake. The server definitely delivered config files not only for Windows, but also for the ARM/MIPS platform. Though unusual,\u00a0the ARM module was delivered by the same server and it processed the same config file.\nLinux plugins\nOver time we were able to collect several plugins as well as the main module for ARM and MIPS architectures. All of these ARM/MIPS object files were compiled from the same source and later pushed out in one config: \u201cweap_msl\u201d, \u201cweap_mps\u201d, \u201cnm_hwi\u201d, \u201cnm_mps\u201d, \u201cweap_hwi\u201d, and \u201cnm_msl\u201d. It\u2019s interesting that the BE2 developers upgraded the ddos plugin to version 2, along with the nm_hwi, nm_mps, and nm_msl plugins. They\u00a0simultaneously released version 5 of the weap_msl, weap_mps, and weap_hmi plugins. Those assignments were not likely arbitrary, as this group had developed BlackEnergy2 for several years in a professional and organized style:\nConfig with a similar set of plugins for different architectures\nHere is the list of retrieved files and related functionality:\nweap\nDDoS Attack (various types)\nps\npassword stealer handling a variety of network protocols (SMTP, POP3, IMAP, HTTP, FTP, Telnet)\nnm\nscans ports, stores banners\nsnif\nlogs IP source and destination, TCP/UDP ports\nhook\nmain module: CnC communication, config parser, plugins loader\nuper\nrewrites hook module with a new version and launches it\nWeap, Snif, Nm plugin grammar mistakes and mis-spellings\nThe developers\u2019 coding style differed across the \u2018Hook\u2019 main module, the plugins, and the Windows main.dll. The hook main module contained encrypted strings and handled all the function calls and strings as the references in a large structure. This structure obfuscation may be a rewrite effort to better modularize the code, but could also\u00a0be intended to complicate analysis. Regardless, it is likely that different individuals coded the different plugins. So, the BE2 effort must have its own small team of plugin and multiplatform developers.\nHook module structure\nAfter decrypting the strings, it became clear that the Linux Hook main module communicated with the same CnC server as other Windows modules:\nThe CNC\u2019s IP address in the Linux module\nThis Linux module can process the following commands, some of which are similar to the Windows version:\ndie\ndelete all BlackEnergy2 files and system traces\nkill\ndelete all BlackEnergy2 files and system traces and reboot\nlexec\nlaunch a command using bin/sh\nrexec\ndownload and launch file using \u2018fork/exec\u2019\nupdate\nrewrite self file\nmigrate\nupdate the CnC server\nWindows Plugins\nAfter the disclosure of an unusual CnC server that pushed Linux and the new Windows plugins we paid greater\u00a0attention to new BE2 samples and associated CnCs.\nDuring an extended period, we were able to collect many Windows plugins from different CnC servers, without\u00a0ever noticing Linux plugins being downloaded as\u00a0described above. It appears the\u00a0BE2/SandWorm gang protected their servers by keeping their non-Windows hacker tools and plugins in separate servers or server folders. Finally, each CnC server hosts a different set of plugins, meaning that each server works with different victims and uses plugins based on its current needs. Here is the summary list of all known plugins at the moment:\nfs\nsearches for given file types, gets primary system and network information\nps\npassword stealer from various sources\nss\nmakes screenshots\nvsnet\nspreads payload in the local network\n(uses psexec, accesses admin shares), gets primary system and network information\nrd\nremote desktop\nscan\nscans ports of a given host\ngrc\nbackup channel via plus.google.com\njn\nfile infector (local, shares, removable devices) with the given payload downloaded from CnC\ncert\ncertificate stealer\nsn\nlogs traffic, extracts login-passwords from different protocol (HTTP, LDAP, FTP, POP3, IMAP, Telnet )\ntv\nsets password hash in the registry for TeamViewer\nprx\nProxy server\ndstr\nDestroys hard disk by overwriting with random data (on application level and driver level) at a certain time\nkl\nkeylogger\nupd\nBE2 service file updater\nusb\ngathers information on connected USBs\n(Device instance ID,\ndrive geometry)\nbios\ngathers information on BIOS, motherboard, processor,\nOS\nWe are pretty sure that our\u00a0list of BE2 tools is not complete. For example, we have yet to\u00a0obtain the router access plugin, but we are confident that it exists. Evidence also supports the hypothesis that there is a encryption plugin for victim files (see below).\nOur current collection represents the BE2 attackers\u2019 capabilities quite well. Some plugins remain\u00a0mysterious and their purpose is not yet\u00a0clear, like \u2018usb\u2019 and \u2018bios\u2019. Why would the attackers need information on usb and bios characteristics? It suggests that based on a specific USB and BIOS devices, the attackers may upload specific\u00a0plugins to carry out additional actions. Perhaps destructive, perhaps to further infect devices. We don\u2019t know yet.\nIt\u2019s also interesting to point out another plugin \u2013 \u2018grc\u2019. In some of the BE2 configuration files, we can notice an value with a \u201cgid\u201d type:\nThe addr number in the config\nThis number is an ID for the plus.google.com service and is used by the \u2018grc\u2019 plugin to parse html. It then downloads and decrypts a PNG file. The decrypted PNG is supposed to contain a new config file, but we never observed one. We are aware of two related GooglePlus IDs. The first one, plus.google.com/115125387226417117030/, contains an abnormal number of views. At the time of writing, the count is 75 million:\nBE2 plus profile\nThe second one \u2013 plus.google.com/116769597454024178039/posts \u2013 is currently more modest at a little over 5,000 views. All of that account\u2019s posts are deleted.\nTracked Commands\nDuring observation of the described above \u201crouter-PC\u201d CnC we tracked the following commands delivered in the config file before the server went offline. Our observation of related\u00a0actions\u00a0here:\nu ps\nstart password stealing (Windows)\nPs_mps/ps_hwi start\nstart password stealing (Linux, MIPS,\nARM)\nuper_mps/uper_hwi start\nrewrite hook module with a new version and launch it (Linux, MIPS, ARM)\nNm_mps/nm_hwi start\n\u2013ban -middle\nScan ports and retrieve banners on the router\u00a0subnet\n(Linux, MIPS,\nARM)\nU fsget * 7 *.docx, *.pdf, *.doc *\nsearch for docs with the given filetypes (Windows)\nS sinfo\nretrieve information on installed programs and launch commands:\nsysteminfo, tasklist, ipconfig, netstat, route print, tracert www.google.com (Windows)\nweap_mps/weap_hwi host188.128.123.52 port[25,26,110,465,995]\ntypetcpconnect\nDDoS on 188.128.123.52 (Linux, MIPS,\nARM)\nweap_mps/weap_hwi\ntypesynflood port80 cnt100000 spdmedium host212.175.109.10\nDDoS on 212.175.109.10 (Linux, MIPS,\nARM)\nThe issued commands for the Linux plugins suggest the attackers controlled infected MIPS/ARM devices.\u00a0We want to pay special attention to the DDoS commands meant for these routers. 188.128.123.52 belongs to the Russian Ministry of Defense and 212.175.109.10 belongs to the Turkish Ministry of Interior\u2019s government site. While many researchers suspect a Russian actor is behind BE2, judging by their tracked activities and the victim profiles, it\u2019s still unclear whose interests they represent.\nWhile observing some other CnCs and pulling down config files, we stumbled upon some strange mistakes and mis-typing. They are highlighted in the image below:\nBE2 config file mistakes\nFirst, these mistakes suggest that the BE2 attackers manually edit these config files. Secondly, it shows that\u00a0even skilled hackers make mistakes.\nHard-Coded Command and Control\nThe contents of the config files themselves are fairly interesting. They all contain a callback c2 with a hardcoded ip address, contain timeouts, and some contain the commands listed above. We include a list of observed\u00a0hardcoded ip C2 addresses here, along with the address owner and geophysical location of the host:\nC2 IP address\nOwner\nCountry\n184.22.205.194\nhostnoc.net\nUS\n5.79.80.166\nLeaseweb\nNL\n46.165.222.28\nLeaseweb\nNL\n95.211.122.36\nLeaseweb\nNL\n46.165.222.101\nLeaseweb\nNL\n46.165.222.6\nLeaseweb\nNL\n89.149.223.205\nLeaseweb\nNL\n85.17.94.134\nLeaseweb\nNL\n46.4.28.218\nHetzner\nDE\n78.46.40.239\nHetzner\nDE\n95.143.193.182\nServerconnect\nSE\n188.227.176.74\nRedstation\nGB\n93.170.127.100\nNadym\nRU\n37.220.34.56\nYisp\nNL\n194.28.172.58\nBesthosting.ua\nUA\n124.217.253.10\nPIRADIUS\nMY\n84.19.161.123\nKeyweb\nDE\n109.236.88.12\nworldstream.nl\nNL\n212.124.110.62\ndigitalone.com\nUS\n5.61.38.31\n3nt.com\nDE\n5.255.87.39\nserverius.com\nNL\nIt\u2019s interesting that one of these servers is a Tor exit node. And, according to the collected config files, the group upgraded their malware communications\u00a0from plain text http to encrypted https in\u00a0October 2013.\nBE2 Targets and Victims\nBlackEnergy2 victims are widely distributed geographically. We identified BlackEnergy2 targets and victims in the following countries starting in late 2013. There are likely more victims.\nRussia\nUkraine\nPoland\nLithuania\nBelarus\nAzerbaijan\nKyrgyzstan\nKazakhstan\nIran\nIsrael\nTurkey\nLibya\nKuwait\nTaiwan\nVietnam\nIndia\nCroatia\nGermany\nBelgium\nSweden\nVictim profiles point to an expansive interest in ICS:\npower generation site owners\npower facilities construction\npower generation operators\nlarge suppliers and manufacturers of heavy power related materials\ninvestors\nHowever, we also noticed that\u00a0the target list includes government, property holding, and technology organizations as well:\nhigh level government\nother ICS construction\nfederal land holding agencies\nmunicipal offices\nfederal emergency services\nspace and earth measurement and assessment labs\nnational standards body\nbanks\nhigh-tech\u00a0transportation\nacademic research\nVictim cases\nWe gained insight into significant BE2 victim profiles over the summer of 2014. Interesting\u00a0BE2 incidents are presented here.\nVictim #1\nThe BE2 attackers successfully spearphished an organization with an exploit for which there is no current CVE, and a metasploit module has been available This email message contained a ZIP archive with EXE file inside that did not appear to be an executable. This crafted zip archive exploited a WinRAR flaw that makes files in zip archives appear to have a different name and file extension.\nBE2 spearphish example\nThe attached exe file turned out to be \u2018BlackEnergy-like\u2019 malware, which researchers already dubbed \u2018BlackEnergy3\u2019 \u2013 the gang uses it along with BlackEnergy2. Kaspersky Lab detects \u2018BlackEnergy3\u2019 malware as Backdoor.Win32.Fonten \u2013 naming it after its dropped file \u201cFONTCACHE.DAT\u201d\nWhen investigating computers in the company\u2019s network, only BE2 associated files were found, suggesting BE3 was used as only a first-stage tool on this network. The config files within BE2 contained the settings of the company\u2019s internal web proxy:\nBE2 config file contains victim\u2019s internal proxy\nAs the APT-specific BE2 now stores the downloaded plugins in encrypted files on the system (not seen in older versions \u2013 all plugins were only in-memory), the administrators were able to collect BE2 files from the infected machines. After decrypting these files, we could retrieve plugins launched on infected machines: ps, vsnet, fs, ss, dstr.\nBy all appearances, the attackers pushed the \u2018dstr\u2019 module when they understood that they were revealed, and wanted to hide their presence on the machines. Some machines already launched the plugin, lost their data and became unbootable.\nDestructive dstr command in BE2 config file\nAlso, on some machines, documents were encrypted, but no related\u00a0plugin could be\u00a0found.\nVictim #2\nThe second organization was hacked via the first victim\u2019s stolen VPN credentials. After the second organization was notified about the infection they started an internal investigation. They confirmed that some data was destroyed on their machines, so the BE2 attackers have exhibited some level of destructive activity. And, they revealed that their Cisco routers with different IOS versions were hacked. They weren\u2019t able to connect to the routers any more by telnet and found the following \u201cfarewell\u201d tcl scripts in the router\u2019s file system:\nCiscoapi.tcl \u2013 contains various wrappers over cisco EXEC-commands as described in the comments.\nThe comment includes a punchy message for \u201ckasperRsky\u201d:\nBE2 ciscoapi.tcl fragment\nKillint.tcl \u2013 uses Ciscoapi.tcl, implements destroying functions:\nBE2 killint.tcl fragment\nThe script tries to download ciscoapi.tcl from a certain FTP server which served as a storage for BE2 files. The organization managed to discover what scripts were hosted on the server before BE/SandWorm gang deleted them, and\u00a0unfortunately couldn\u2019t restore them after they were deleted. The BE2 actor performs careful, professional activity covering their tracks:\nciscoapi.tcl\nkillint.tcl\ntelnetapi2.tcl\ntelnetu.tcl\nstub.tcl\nstub1.tcl\nThere is evidence that the logs produced by some scripts were also stored on the FTP server, in particular the information on CDP neighbors\u00a0which is provided by one of the procedures of ciscoapi.tcl.\nVictim #3\nThe third organization got compromised by the same type of attack as the first one (an EXE file spoofing a doc within a Zip archive). All the plugins discovered in BE2 files were known, and there was no revelation of hacked network devices on their side and no destroyed data. The noticeable thing is that many computers contained both BE2 and BE3 files and some config files contained the following URL:\nhxxps://46.165.222(dot)28/upgrade/f3395cd54cf857ddf8f2056768ff49ae/getcfg.php\nThe URL contains the md5 of the string \u2018router\u2019. One of the discovered config files contained a URL with an as yet unidentified md5:\nhxxps://46.165.222(dot)28/upgrade/bf0dac805798cc1f633f19ce8ed6382f/upgrade.php\nVictim set #4\nA set of victims discovered\u00a0installed Siemens SCADA software in their ICS environment was responsible for downloading and executing BlackEnergy. Starting in March 2014 and ending in July 2014, Siemens \u201cccprojectmgr.exe\u201d downloaded and executed a handful of\u00a0different payloads hosted at\u00a094.185.85.122/favicon.ico. They are all detected as variants of\u00a0\u201cBackdoor.Win32.Blakken\u201d.\nBuild IDs\nEach config file within BE2 main.dll has a field called build_id which identifies the malware version for the operators. Currently this particular BE/SandWorm gang uses a certain pattern for the build ids containing three hex numbers and three letters, as follows:\n0C0703hji\nThe numbers indicate the date of file creation in the format: Year-Month-Day. Still, the purpose of the letters is unknown, but most likely it indicates the targets.\u00a0The hex numbers weren\u2019t used all the time, sometimes we observed decimal numbers:\n100914_mg\n100929nrT\nMost interesting for us was the earliest build id we could find. Currently it is \u201cOB020Ad0V\u201d, meaning that the BE2/SandWorm APT started operating as early as the beginning of 2010.\nAppendix: IoC\nSince BE dropper installs its driver under a randomly picked non-used Windows driver name, there is no a static name for a driver to use it as IOC. The driver is self-signed on 64-bit systems\nHowever, new \u201cAPT\u201d BE2 uses one of the following filenames that\u00a0are used as an encrypted storage for plugins and the network settings. They are consistent and\u00a0serve as stable\u00a0IoC:\n%system32%driverswinntd_.dat\n%system32%driverswinntd.dat\n%system32%driverswincache.dat\n%system32%driversmlang.dat\n%system32%driversosver32nt.dat\n%LOCALAPPDATA%adobewind002.dat\n%LOCALAPPDATA%adobesettings.sol\n%LOCALAPPDATA%adobewinver.dat\n%LOCALAPPDATA%adobecache.dat\nBE2 also uses start menu locations for persistence:\nUsersuserAppDataRoamingMicrosoftWindowsStart MenuProgramsStartupflashplayerapp.exe\nBE3 uses the following known filenames:\n%USERPROFILE%NTUSER.LOG\n%LOCALAPPDATA%FONTCACHE.DAT\nBE2 MD5s:\nd57ccbb25882b16198a0f43285dafbb4\n7740a9e5e3feecd3b7274f929d37bccf\n948cd0bf83a670c05401c8b67d2eb310\nf2be8c6c62be8f459d4bb7c2eb9b9d5e\n26a10fa32d0d7216c8946c8d83dd3787\n8c51ba91d26dd34cf7a223eaa38bfb03\nc69bfd68107ced6e08fa22f72761a869\n3cd7b0d0d256d8ff8c962f1155d7ab64\n298b9a6b1093e037e65da31f9ac1a807\nd009c50875879bd2aefab3fa1e20be09\n88b3f0ef8c80a333c7f68d9b45472b88\n17b00de1c61d887b7625642bad9af954\n27eddda79c79ab226b9b24005e2e9b6c\n48937e732d0d11e99c68895ac8578374\n82418d99339bf9ff69875a649238ac18\nf9dcb0638c8c2f979233b29348d18447\n72372ffac0ee73dc8b6d237878e119c1\nc229a7d86a9e9a970d18c33e560f3dfc\nef618bd99411f11d0aa5b67d1173ccdf\n383c07e3957fd39c3d0557c6df615a1a\n105586891deb04ac08d57083bf218f93\n1deea42a0543ce1beeeeeef1ffb801e5\n7d1e1ec1b1b0a82bd0029e8391b0b530\n1f751bf5039f771006b41bdc24bfadd3\nd10734a4b3682a773e5b6739b86d9b88\n632bba51133284f9efe91ce126eda12d\na22e08e643ef76648bec55ced182d2fe\n04565d1a290d61474510dd728f9b5aae\n3c1bc5680bf93094c3ffa913c12e528b\n6a03d22a958d3d774ac5437e04361552\n0217eb80de0e649f199a657aebba73aa\n79cec7edf058af6e6455db5b06ccbc6e\nf8453697521766d2423469b53a233ca7\n8a449de07bd54912d85e7da22474d3a9\n3f9dc60445eceb4d5420bb09b9e03fbf\n8f459ae20291f2721244465aa6a6f7b9\n4b323d4320efa67315a76be2d77a0c83\n035848a0e6ad6ee65a25be3483af86f2\n90d8e7a92284789d2e15ded22d34ccc3\nedb324467f6d36c7f49def27af5953a5\nc1e7368eda5aa7b09e6812569ebd4242\nec99e82ad8dbf1532b0a5b32c592efdf\n391b9434379308e242749761f9edda8e\n6bf76626037d187f47a54e97c173bc66\n895f7469e50e9bb83cbb36614782a33e\n1feacbef9d6e9f763590370c53cd6a30\n82234c358d921a97d3d3a9e27e1c9825\n558d0a7232c75e29eaa4c1df8a55f56b\ne565255a113b1af8df5adec568a161f3\n1821351d67a3dce1045be09e88461fe9\nb1fe41542ff2fcb3aa05ff3c3c6d7d13\n53c5520febbe89c25977d9f45137a114\n4513e3e8b5506df268881b132ffdcde1\n19ce80e963a5bcb4057ef4f1dd1d4a89\n9b29903a67dfd6fec33f50e34874b68b\nb637f8b5f39170e7e5ada940141ddb58\nc09683d23d8a900a848c04bab66310f1\n6d4c2cd95a2b27777539beee307625a2\ne32d5c22e90cf96296870798f9ef3d15\n64c3ecfd104c0d5b478244fe670809cc\nb69f09eee3da15e1f8d8e8f76d3a892a\n294f9e8686a6ab92fb654060c4412edf\n6135bd02103fd3bab05c2d2edf87e80a\nb973daa1510b6d8e4adea3fb7af05870\n8dce09a2b2b25fcf2400cffb044e56b8\n6008f85d63f690bb1bfc678e4dc05f97\n1bf8434e6f6e201f10849f1a4a9a12a4\n6cac1a8ba79f327d0ad3f4cc5a839aa1\n462860910526904ef8334ee17acbbbe5\neeec7c4a99fdfb0ef99be9007f069ba8\n6bbc54fb91a1d1df51d2af379c3b1102\n8b152fc5885cb4629f802543993f32a1\n6d1187f554040a072982ab4e6b329d14\n3bfe642e752263a1e2fe22cbb243de57\nc629933d129c5290403e9fce8d713797\n1c62b3d0eb64b1511e0151aa6edce484\n811fcbadd31bccf4268653f9668c1540\n0a89949a3a933f944d0ce4c0a0c57735\na0f594802fbeb5851ba40095f7d3dbd1\nbf6ce6d90535022fb6c95ac9dafcb5a5\ndf84ff928709401c8ad44f322ec91392\nfda6f18cf72e479570e8205b0103a0d3\n39835e790f8d9421d0a6279398bb76dc\nfe6295c647e40f8481a16a14c1dfb222\n592c5fbf99565374e9c20cade9ac38aa\nad8dc222a258d11de8798702e52366aa\nbc21639bf4d12e9b01c0d762a3ffb15e\n3122353bdd756626f2dc95ed3254f8bf\ne02d19f07f61d73fb6dd5f7d06e9f8d2\nd2c7bf274edb2045bc5662e559a33942\nac1a265be63be7122b94c63aabcc9a66\ne06c27e3a436537a9028fdafc426f58e\n6cf2302e129911079a316cf73a4d010f\n38b6ad30940ddfe684dad7a10aea1d82\nf190cda937984779b87169f35e459c3a\n698a41c92226f8e444f9ca7647c8068c\nbc95b3d795a0c28ea4f57eafcab8b5bb\n82127dc2513694a151cbe1a296258850\nd387a5e232ed08966381eb2515caa8e1\nf4b9eb3ddcab6fd5d88d188bc682d21d\n8e42fd3f9d5aac43d69ca740feb38f97\na43e8ddecfa8f3c603162a30406d5365\nea7dd992062d2f22166c1fca1a4981a1\n7bf6dcf413fe71af2d102934686a816b\ncf064356b31f765e87c6109a63bdbf43\n4a46e2dc16ceaba768b5ad3cdcb7e097\n2134721de03a70c13f2b10cfe6018f36\n7add5fd0d84713f609679840460c0464\ncc9402e5ddc34b5f5302179c48429a56\n9803e49d9e1c121346d5b22f3945bda8\nc5f5837bdf486e5cc2621cc985e65019\n2b72fda4b499903253281ebbca961775\n7031f6097df04f003457c9c7ecbcda1c\n6a6c2691fef091c1fc2e1c25d7c3c44c\n9bd3fa59f30df5d54a2df385eba710a5\n5100eb13cac2fc3dec2d00c5d1d3921c\n0a2c2f5cf97c65f6473bdfc90113d81e\n30b74abc22a5b75d356e3a57e2c84180\na0424e8436cbc44107119f62c8e7491b\nc1ba892d254edd8a580a16aea6f197e9\ne70976785efcfaeed20aefab5c2eda60\n397b5d66bac2eb5e950d2a4f9a5e5f2c\n4e9bde9b6abf7992f92598be4b6d1781\n54d266dee2139dd82b826a9988f35426\n5b4faa2846e91e811829a594fecfe493\n907448af4388072cdc01e69b7b97b174\nccad214045af69d06768499a0bd3d556\n1395dfda817818c450327ab331d51c1b\n715e9e60be5a9b32075189cb04a0247e\n3835c8168d66104eed16c2cd99952045\nf32c29a620d72ec0a435982d7a69f683\n95e9162456d933fff9560bee3c270c4e\nda01ef50673f419cf06b106546d06b50\n2dd4c551eacce0aaffedf4e00e0d03de\n34f80f228f8509a67970f6062075e211\n81ca7526881a0a41b6721048d2f20874\nd642c73d0577dd087a02069d46f68dac\nBE3 MD5s:\nf0ebb6105c0981fdd15888122355398c\n7cb6363699c5fd683187e24b35dd303e\n4d5c00bddc8ea6bfa9604b078d686d45\nf37b67705d238a7c2dfcdd7ae3c6dfaa\n46649163c659cba8a7d0d4075329efa3\n628ef31852e91895d601290ce44650b1\n723eb7a18f4699c892bc21bba27a6a1a\n8b9f4eade3a0a650af628b1b26205ba3\nf6c47fcc66ed7c3022605748cb5d66c6\n6c1996c00448ec3a809b86357355d8f9\nfaab06832712f6d877baacfe1f96fe15\n2c72ef155c77b306184fa940a2de3844\n2e62e8949d123722ec9998d245bc1966\nb0dc4c3402e7999d733fa2b668371ade\n93fa40bd637868a271002a17e6dbd93b\nf98abf80598fd89dada12c6db48e3051\n8a7c30a7a105bd62ee71214d268865e3\n2f6582797bbc34e4df47ac25e363571d\n81d127dd7957e172feb88843fe2f8dc1\n3e25544414030c961c196cea36ed899d\nPrevious and Parallel Research\nBotnet History Illustrated by BlackEnergy 2, PH Days, Kaspersky Lab \u2013 Maria Garnaeva and Sergey Lozhkin, May 2014\nBlackEnergy and Quedagh (pdf), F-Secure, September 2014\nSandworm, iSIGHT Partners, October 2014\nAlert (ICS-ALERT-14-281-01A)\u00a0Ongoing Sophisticated Malware Campaign Compromising ICS (Update A), ICS-CERT, October 2014\nAPT\nBlackEnergy\nCyber espionage\nDDoS-attacks\nTargeted attacks\nAuthors\nKurt Baumgartner\nMaria Garnaeva\nBE2 custom plugins, router abuse, and target profiles\nYour email address will not be published. Required fields are marked *Name *\nEmail *\nCancel\n\u0394\njayaram Bharathi\nPosted on\nNovember 4, 2014. 12:52 am\nIt is very helpful for understanding the threat available in the real world. It is good to receive the regular posts on any posts related to threat\nReply\nKevinUK\nPosted on\nNovember 5, 2014. 2:34 pm\nQuote \u201d The decrypted PNG is supposed to contain a new CNC address, but we never observed one.\u201d\nDid you consider steganography may be being employed at that time?\nReply\nMaria Garnaeva\nPosted on\nNovember 7, 2014. 10:50 am\nYes, steganography is used here. What we meant is that we never observed a PNG file itself\nReply\nfrederick\nPosted on\nNovember 12, 2014. 8:13 am\n\u201c\u2026remain mysterious and their purpose is not yet clear, like \u2018usb\u2019 and \u2018bios\u2019. \u2026\u201d\nThis COULD be for infecting USB firmware and UEFI bugs.\nIf this is successfull your Antivirus software can search and search and will find nothing.\nWhen you find something suspicious on your harddrive or in memory the infection vector still stays active.\nReply\nTable of Contents\nBrief HistoryThe Plugins and Config FilesLinux pluginsWindows PluginsTracked CommandsHard-Coded Command and ControlBE2 Targets and VictimsVictim casesBuild IDsAppendix: IoCPrevious and Parallel Research\nGReAT webinars\n13 May 2021, 1:00pm\nGReAT Ideas. Balalaika Edition\nBoris Larin\nDenis Legezo\n26 Feb 2021, 12:00pm\nGReAT Ideas. Green Tea Edition\nJohn Hultquist\nBrian Bartholomew\nSuguru Ishimaru\nVitaly Kamluk\nSeongsu Park\nYusuke Niwa\nM